<!DOCTYPE html>
<html>
<head>
    <title>Lamp Animation</title>
    <style>
        body {
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        #animation {
            white-space: pre;
            text-align: left;
            line-height: 1.0;
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 0;
            word-spacing: 0;
            transform: scale(1.2);
            transform-origin: center;
        }
        
        /* Style for the thank you message */
        .thank-you-message {
            color: #FFD700; /* Gold color */
            font-size: 28px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            margin-bottom: 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="animation" class="hidden"></div>
    <audio id="egyptianSound" preload="auto">
        <source src="/egyptian_sound" type="audio/ogg">
    </audio>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        const animationDiv = document.getElementById('animation');
        let frames = [];
        let duration = 200;
        
        // Load animation data from backend
        fetch('/api/animation/frames')
            .then(response => response.json())
            .then(data => {
                frames = data.frames;
                duration = data.duration;
                console.log('Animation loaded:', frames.length, 'frames');
            })
            .catch(error => {
                console.error('Error loading animation:', error);
            });
        
        function playAnimation(subscriberData = null) {
            animationDiv.classList.remove('hidden');
            let currentFrame = 0;
            
            // Start playing the Egyptian sound
            const audio = document.getElementById('egyptianSound');
            audio.currentTime = 0;
            audio.volume = 1.0;
            audio.play().catch(e => console.log('Audio play failed:', e));
            
            const interval = setInterval(() => {
                if (currentFrame < frames.length) {
                    let frameContent = frames[currentFrame];
                    
                    // Add thank you message if subscriber data is provided
                    if (subscriberData) {
                        let message = '';
                        if (subscriberData.type === 'gift') {
                            const count = subscriberData.count > 1 ? 's' : '';
                            message = `Thanks ${subscriberData.gifter} for the ${subscriberData.count} gifted sub${count}!`;
                        } else {
                            const months = subscriberData.months > 1 ? 's' : '';
                            message = `Thanks ${subscriberData.subscriber} for the ${subscriberData.months} month${months} sub!`;
                        }
                        
                        // Create HTML with styled message
                        const messageHtml = `<div class="thank-you-message">${message}</div>`;
                        const frameHtml = `<pre>${frameContent}</pre>`;
                        animationDiv.innerHTML = messageHtml + frameHtml;
                    } else {
                        animationDiv.innerHTML = `<pre>${frameContent}</pre>`;
                    }
                    currentFrame++;
                } else {
                    clearInterval(interval);
                    animationDiv.classList.add('hidden');
                    
                    // Fade out the audio
                    fadeOutAudio(audio);
                }
            }, duration);
        }
        
        function fadeOutAudio(audio) {
            const fadeInterval = setInterval(() => {
                if (audio.volume > 0.1) {
                    audio.volume -= 0.1;
                } else {
                    audio.pause();
                    audio.volume = 1.0; // Reset volume for next time
                    clearInterval(fadeInterval);
                }
            }, 100); // Fade out over ~1 second
        }
        
        // Listen for subscription events
        socket.on('sub_event', function(data) {
            console.log('Subscription detected:', data);
            playAnimation({
                type: 'sub',
                subscriber: data.subscriber,
                months: data.months
            });
        });
        
        socket.on('gift_sub_event', function(data) {
            console.log('Gift subscription detected:', data);
            playAnimation({
                type: 'gift',
                gifter: data.gifter,
                count: data.count
            });
        });
        
        // For testing - you can trigger manually
        window.playTest = function() {
            playAnimation({
                type: 'sub',
                subscriber: 'TestUser',
                months: 1
            });
        };
    </script>
</body>
</html> 